---
title: "simulation_rst"
author: "Rui Hu"
date: "8/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('R/estimate.R')
```

## Generating $Y$ depending on $A$
### Using SL.gam to estimate $\hat \pi$ and $\hat \mu$

When $n$ is large, `one-step` estimator of $\psi(P)$ tend to be non-negative.
```{r}
# ests.sim.1 <-  est.psi.sim(200*c(1:10), 1:500, 
#                           func_1 = "SL.gam", func_2 = "SL.gam", null.sims=FALSE)
load("ests.sim.1.RData")
est.psi.plot(ests.sim.1, plot.type='density')
```

`one-step` estimator of $\theta(P)$ tend to be negative.
```{r}
est.theta.plot(ests.sim.1, plot.type='density')
```

When $n$ is increasing, the coverage is decreasing and the bias is increasing.
```{r}
summaries.psi <- est.psi.summary(ests.sim.1)
ggplot(summaries.psi) +
  geom_line(aes(n, coverage, color=type)) +
  geom_hline(yintercept=.95)
ggplot(summaries.psi) +
  geom_line(aes(n, sqrt(n) * bias, color=type))
```

I am looking for possible explanations.     
* [x] The MSE of gam model is the lowest among the three models. Thus the reason that leads to low coverage should not be the selection of model.   

```{r}
summaries.theta <- est.theta.summary(ests.sim.1)
ggplot(summaries.theta) +
  geom_line(aes(n, coverage, color=type)) +
  geom_hline(yintercept=.95)
```

### Using SL.earth to estimate $\hat \pi$ and $\hat \mu$
Since the model will do the variable selection, $A$ might not be included to the estimated model and thus $\hat \tau=0$ and $\hat \theta(P)=0.$
```{r}
load("ests.sim.3.RData")
est.theta.plot(ests.sim.3, plot.type='density')
summaries.theta.3 <- est.theta.summary(ests.sim.3)
ggplot(summaries.theta.3) +
  geom_line(aes(n, coverage, color=type)) +
  geom_hline(yintercept=.95)
```


## Generating $Y$ not depending on $A$
```{r}
# ests.sim.1.null <-  est.psi.sim(200*c(1:10), 1:500, 
#                            func_1 = "SL.gam", func_2 = "SL.gam", null.sims=TRUE)
load("ests.sim.1.null.RData")
est.psi.plot(ests.sim.1.null, plot.type='density')
```

```{r}
est.theta.plot(ests.sim.1.null, plot.type='density')
```

```{r}
summaries.psi.null <- est.psi.summary(ests.sim.1.null)
ggplot(summaries.psi.null) +
  geom_line(aes(n, coverage, color=type)) +
  geom_hline(yintercept=.95)
```

```{r}
summaries.theta.null <- est.theta.summary(ests.sim.1.null)
ggplot(summaries.theta.null) +
  geom_line(aes(n, coverage, color=type)) +
  geom_hline(yintercept=.95)
```
